# 内存映射驱动实验

本实验实现了一个使用vma fault机制的内存映射驱动程序。

## 实验要求

1. 在加载驱动程序时利用get_free_pages函数申请一片64KB的连续物理地址空间
2. 利用vma fault机制实现对申请到的64KB地址空间进行内存映射
3. 编写应用程序利用mmap进行内存映射，读写映射内存区域
4. 通过打印输出观察具体每个页面实际进行内存映射的时机
5. 在卸载驱动程序时利用free_pages释放申请到的64KB空间

## 文件结构

- `mmap_driver.c`: 内存映射驱动程序
- `test_mmap.c`: 测试应用程序
- `Makefile`: 用于编译和安装

## 驱动工作原理

1. 驱动使用`__get_free_pages`申请16个连续页面（64KB）的内存
2. 实现了VMA的fault处理函数，按需将内核物理内存映射到用户空间虚拟地址
3. 当用户首次访问某个页面时，会触发page fault，此时驱动将该页面映射到用户空间
4. 使用page fault机制实现了按需加载，只有实际访问的页面才会被映射

## 编译方法

编译驱动程序和测试程序：

```
make
```

## 安装和卸载

安装驱动程序（需要root权限）：

```
sudo make install
```

卸载驱动程序（需要root权限）：

```
sudo make uninstall
```

## 测试方法

自动加载驱动并运行测试（需要root权限）：

```
sudo make test
```

或手动测试：

```
sudo make install
./test_mmap
```

## 测试程序功能

1. 打开设备文件并映射64KB内存
2. 按顺序访问每个页面的起始位置（共16个页面），触发页面故障
3. 读取每个页面的数据
4. 访问随机位置，测试页面是否已映射
5. 释放映射并关闭设备

## 预期输出

1. 每次首次访问新页面时会触发页面故障，内核日志会显示"fault handler called"
2. 已映射的页面再次访问不会触发页面故障
3. 驱动卸载时应该释放全部分配的内存 